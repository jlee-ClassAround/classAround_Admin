generator client {
  provider = "prisma-client-js"
  output   = "../../src/generated/ivy"
}

datasource db {
  provider  = "postgresql"
  url       = env("IVY_DATABASE_URL")
  directUrl = env("IVY_DIRECT_URL")
}

model User {
  id       String  @id @default(uuid())
  username String?
  nickname String?
  email    String? @unique
  password String?
  phone    String? @unique

  avatar          String?
  kakaoId         String? @unique
  kajabiContactId String? @unique

  optedIn Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roleId String?
  Role   Role?   @relation(fields: [roleId], references: [id])

  userProgresses UserProgress[]
  enrollments    Enrollment[]
  applyCourses   ApplyCourse[]
  tossCustomers  TossCustomer[]
  userCoupons    UserCoupon[]
  revenues       Revenue[]
  revieww        Review[]
  contacts       Contact[]
  userTags       UserTag[]
  ebookPurchases EbookPurchase[]
}

model Course {
  id String @id @default(uuid())

  title       String  @default("")
  description String?

  productType ProductType @default(SIMPLE)

  originalPrice     Int?
  discountedPrice   Int?
  showInInstallment Boolean @default(false)
  isTaxFree         Boolean @default(false)

  thumbnail   String?
  isPublished Boolean @default(false)
  isHidden    Boolean @default(false)

  isFocusMode Boolean @default(false)

  isUpcoming Boolean   @default(false)
  endDate    DateTime?

  maxPurchaseCount Int?
  accessDuration   Int?

  kakaoRoomLink     String?
  kakaoRoomPassword String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  teachers Teacher[]

  detailImages DetailImage[]
  chapters     Chapter[]
  enrollments  Enrollment[]

  reviews Review[]

  options       CourseOption[]
  tossCustomers TossCustomer[]
  productBadge  ProductBadge[]
  coupons       Coupon[]
}

model FreeCourse {
  id String @id @default(uuid())

  title       String  @default("")
  description String?

  thumbnail   String?
  isPublished Boolean @default(false)
  isHidden    Boolean @default(false)

  kakaoRoomLink     String?
  kakaoRoomPassword String?
  kakaoTemplateId   String?
  location          String?
  webhookUrl        String?
  kajabiTagId       String?

  isUpcoming Boolean   @default(false)
  endDate    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  productBadge ProductBadge[]
  teachers     Teacher[]
  detailImages DetailImage[]
  applyCourses ApplyCourse[]
}

model CourseOption {
  id String @id @default(cuid())

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  name String

  originalPrice    Int
  discountedPrice  Int?
  isTaxFree        Boolean @default(false)
  maxPurchaseCount Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollments Enrollment[]
}

enum ProductType {
  SIMPLE
  OPTION
}

model DetailImage {
  id       String @id @default(uuid())
  name     String
  imageUrl String
  position Int

  courseId     String?
  course       Course?     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  ebookId      String?
  ebook        Ebook?      @relation(fields: [ebookId], references: [id], onDelete: Cascade)
  freeCourseId String?
  freeCourse   FreeCourse? @relation(fields: [freeCourseId], references: [id], onDelete: Cascade)

  uploadedAt DateTime @default(now())
}

model Role {
  id    String @id
  users User[]
}

enum CategoryType {
  COURSE
  FREE_COURSE
  EBOOK
  TEACHER
  FAQ
  NOTICE
}

model Category {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        CategoryType

  courses     Course[]
  teachers    Teacher[]
  ebooks      Ebook[]
  notices     Notice[]
  faqs        Faq[]
  freeCourses FreeCourse[]

  @@unique([name, type])
}

model Chapter {
  id String @id @default(uuid())

  title       String  @default("새로운 챕터")
  description String?
  position    Int

  isPublished Boolean @default(false)

  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lessons Lesson[]
}

model Lesson {
  id String @id @default(uuid())

  title       String  @default("새로운 강의")
  description String?
  position    Int

  videoType String  @default("vimeo")
  videoUrl  String?

  isPublished Boolean @default(false)
  isFree      Boolean @default(false)

  chapterId String
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userProgresses UserProgress[]
  MuxData        MuxData?
  attachments    Attachment[]
}

model UserProgress {
  id String @id @default(uuid())

  isCompleted Boolean @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
}

model Attachment {
  id String @id @default(cuid())

  name String @default("new file")
  url  String

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id   String @id @default(cuid())
  name String @unique

  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userTags UserTag[]
}

model UserTag {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tagId String
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tagId])
}

model ProductBadge {
  id          String  @id @default(cuid())
  name        String
  description String?
  color       String?
  textColor   String?

  courses     Course[]
  ebooks      Ebook[]
  freeCourses FreeCourse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MuxData {
  id         String  @id @default(uuid())
  assetId    String
  playbackId String?

  lessonId String @unique
  lesson   Lesson @relation(fields: [lessonId], references: [id])
}

model Enrollment {
  id String @id @default(uuid())

  startDate   DateTime  @default(now())
  endDate     DateTime?
  isActive    Boolean   @default(true)
  enrollCount Int       @default(1)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  courseOptionId String?
  courseOption   CourseOption? @relation(fields: [courseOptionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
}

model ApplyCourse {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  freeCourseId String
  freeCourse   FreeCourse @relation(fields: [freeCourseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, freeCourseId])
}

// enum PaymentStatus {
//   COMPLETED
//   CANCELLED
//   REFUNDED
//   PARTIAL_REFUNDED
// }

model TossCustomer {
  id String @id @default(uuid())

  orderId    String @unique
  paymentKey String @unique
  orderName  String

  originalPrice Int
  discountPrice Int?
  couponType    String?
  couponAmount  Int?
  finalPrice    Int
  isTaxFree     Boolean @default(false)

  productType     String // "COURSE" | "EBOOK"
  productId       String
  productTitle    String
  productOptionId String?
  productOption   Json?

  paymentStatus    String    @default("COMPLETED")
  cancelAmount     Int?
  cancelReason     String?
  refundableAmount Int?
  canceledAt       DateTime?
  receiptUrl       String?

  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  ebookId  String?
  ebook    Ebook?  @relation(fields: [ebookId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([courseId])
  @@index([ebookId])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([productId])
}

model Teacher {
  id      String  @id @default(uuid())
  name    String
  info    String?
  profile String?

  isPublished Boolean @default(false)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  courses     Course[]
  freeCourses FreeCourse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Coupon {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?

  discountType   String
  discountAmount Int
  expiryDate     DateTime

  usageLimit Int?
  usedCount  Int  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userCoupons UserCoupon[]
  courses     Course[]
}

model UserCoupon {
  id String @id @default(uuid())

  userId   String
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponId String
  coupon   Coupon    @relation(fields: [couponId], references: [id], onDelete: Cascade)
  isUsed   Boolean   @default(false)
  usedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, couponId])
}

model Revenue {
  id Int @id @default(autoincrement())

  title   String
  content String

  amount   Int?
  photo    String?
  videoUrl String?

  view Int @default(0)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notice {
  id Int @id @default(autoincrement())

  title   String
  content String

  view        Int     @default(0)
  isPublished Boolean @default(false)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Faq {
  id Int @id @default(autoincrement())

  title       String
  content     String
  isPublished Boolean @default(false)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id Int @id @default(autoincrement())

  title   String
  content String

  rating Float @default(5)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: Cascade)

  view Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contact {
  id Int @id @default(autoincrement())

  title   String
  content String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id Int @id @default(autoincrement())

  title   String
  content String

  thumbnail String?

  view Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HeroSlider {
  id String @id @default(uuid())

  title       String
  isShowTitle Boolean   @default(false)
  teacherName String?
  openDate    DateTime?
  badge       String?
  image       String
  isPublished Boolean   @default(false)

  link    String
  isBlank Boolean @default(false)

  position Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteSetting {
  id Int @id

  businessName String?
  businessInfo String?

  contactLink      String?
  youtubeLink      String?
  instagramLink    String?
  naverCafeLink    String?
  communityLink    String?
  teacherApplyLink String?
  recruitmentLink  String?

  courseRefundPolicy String?
  ebookRefundPolicy  String?
  marketingPolicy    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Terms {
  id Int @id @default(autoincrement())

  title   String
  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
  id Int @id @default(autoincrement())

  title        String
  content      String
  thumbnail    String?
  view         Int     @default(0)
  externalLink String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Ebook {
  id          String  @id @default(uuid())
  title       String
  description String?
  thumbnail   String?
  fileUrl     String?

  originalPrice     Int?
  discountedPrice   Int?
  showInInstallment Boolean   @default(false)
  isPublished       Boolean   @default(false)
  isFocusMode       Boolean   @default(false)
  isUpcoming        Boolean   @default(false)
  endDate           DateTime?
  isTaxFree         Boolean   @default(false)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  purchases    EbookPurchase[]
  productBadge ProductBadge[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  detailImages  DetailImage[]
  tossCustomers TossCustomer[]
}

model EbookPurchase {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  ebookId String
  ebook   Ebook  @relation(fields: [ebookId], references: [id], onDelete: Cascade)

  purchasePrice  Int
  downloadCount  Int       @default(0)
  lastDownloadAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, ebookId])
}
